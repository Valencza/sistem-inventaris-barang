generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==========================================
// ENUMS
// ==========================================

enum MovementType {
  IN
  OUT
  ADJUSTMENT
  TRANSFER_IN
  TRANSFER_OUT
}

enum TransferStatus {
  DRAFT
  POSTED
  CANCELLED
}

// ==========================================
// USER & RBAC (multi-role)
// ==========================================

model User {
  id           String   @id @default(cuid())
  email        String   @unique @db.VarChar(255)
  name         String   @db.VarChar(120)
  passwordHash String   @db.VarChar(255)
  avatar       String?  @db.VarChar(500)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Multi-role
  roles        UserRole[]

  // Audit & inventory
  auditLogs       AuditLog[]
  stockMovements  StockMovement[]

  transfersCreated Transfer[] @relation("TransferCreatedBy")
  transfersPosted  Transfer[] @relation("TransferPostedBy")

  @@map("users")
  @@index([email])
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique @db.VarChar(80)
  description String?  @db.VarChar(255)
  isSystem    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       UserRole[]
  permissions RolePermission[]

  @@map("roles")
}

model Permission {
  id          String   @id @default(cuid())
  code        String   @unique @db.VarChar(120) // contoh: "product.read"
  name        String   @db.VarChar(120)
  description String?  @db.VarChar(255)
  module      String   @db.VarChar(60) // product/category/warehouse/stock/transfer/user/role
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  roles       RolePermission[]

  @@map("permissions")
  @@index([module])
  @@index([code])
}

// Join table: User <-> Role (multi-role)
model UserRole {
  userId     String
  roleId     String
  assignedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@index([roleId])
  @@map("user_roles")
}

// Join table: Role <-> Permission
model RolePermission {
  roleId       String
  permissionId String
  createdAt    DateTime @default(now())

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@index([permissionId])
  @@map("role_permissions")
}

// ==========================================
// PRODUCT & CATEGORY
// ==========================================

model Category {
  id          String   @id @default(cuid())
  name        String   @unique @db.VarChar(120)
  slug        String   @unique @db.VarChar(160)
  description String?  @db.VarChar(500)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  products    Product[]

  @@map("categories")
}

model Product {
  id          String   @id @default(cuid())
  sku         String   @unique @db.VarChar(80)
  name        String   @db.VarChar(180)
  slug        String   @unique @db.VarChar(200)
  description String?  @db.VarChar(2000)

  // Harga uang: gunakan Decimal dengan precision/scale untuk PostgreSQL
  price       Decimal  @db.Decimal(14, 2)

  unit        String   @default("pcs") @db.VarChar(20)
  imageUrl    String?  @db.VarChar(500)
  minStock    Int      @default(0)

  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  categoryId  String
  category    Category @relation(fields: [categoryId], references: [id], onDelete: Restrict)

  stocks         Stock[]
  stockMovements StockMovement[]
  transferItems  TransferItem[]

  @@map("products")
  @@index([categoryId])
  @@index([name])
}

// ==========================================
// WAREHOUSE & STOCK (stok & minStock per gudang)
// ==========================================

model Warehouse {
  id        String   @id @default(cuid())
  code      String   @unique @db.VarChar(30)
  name      String   @db.VarChar(120)
  address   String?  @db.VarChar(255)
  pic       String?  @db.VarChar(120)
  phone     String?  @db.VarChar(50)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  stocks         Stock[]
  stockMovements StockMovement[]
  transfersFrom  Transfer[] @relation("TransferFromWarehouse")
  transfersTo    Transfer[] @relation("TransferToWarehouse")

  @@map("warehouses")
  @@index([name])
}

model Stock {
  id          String   @id @default(cuid())

  // saldo stok saat ini di gudang tsb
  quantity    Int      @default(0)

  // minimum stok khusus untuk gudang tsb (low-stock alert per gudang)
  minStock    Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  productId   String
  warehouseId String

  product     Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  // 1 baris stok per produk per gudang (saldo)
  @@unique([productId, warehouseId])
  @@index([warehouseId])
  @@map("stocks")
}

// ==========================================
// STOCK MOVEMENT (audit stok)
// ==========================================

model StockMovement {
  id          String       @id @default(cuid())
  type        MovementType
  quantity    Int
  notes       String?      @db.VarChar(500)
  createdAt   DateTime     @default(now())

  previousQty Int          @default(0)
  newQty      Int          @default(0)

  productId   String
  warehouseId String
  userId      String
  transferId  String?

  product     Product      @relation(fields: [productId], references: [id], onDelete: Restrict)
  warehouse   Warehouse    @relation(fields: [warehouseId], references: [id], onDelete: Restrict)
  user        User         @relation(fields: [userId], references: [id], onDelete: Restrict)
  transfer    Transfer?    @relation(fields: [transferId], references: [id], onDelete: SetNull)

  @@map("stock_movements")
  @@index([productId, createdAt])
  @@index([warehouseId, createdAt])
  @@index([transferId])
}

// ==========================================
// TRANSFER (draft/posted)
// ==========================================

model Transfer {
  id             String         @id @default(cuid())
  transferNumber String         @unique @db.VarChar(40)
  status         TransferStatus @default(DRAFT)
  notes          String?        @db.VarChar(500)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  postedAt       DateTime?
  cancelledAt    DateTime?

  fromWarehouseId String
  toWarehouseId   String
  createdById     String
  postedById      String?

  fromWarehouse Warehouse @relation("TransferFromWarehouse", fields: [fromWarehouseId], references: [id], onDelete: Restrict)
  toWarehouse   Warehouse @relation("TransferToWarehouse", fields: [toWarehouseId], references: [id], onDelete: Restrict)

  createdBy User  @relation("TransferCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  postedBy  User? @relation("TransferPostedBy", fields: [postedById], references: [id], onDelete: Restrict)

  items          TransferItem[]
  stockMovements StockMovement[]

  @@map("transfers")
  @@index([status, createdAt])
  @@index([fromWarehouseId])
  @@index([toWarehouseId])
}

model TransferItem {
  id         String   @id @default(cuid())
  quantity   Int

  transferId String
  productId  String

  transfer Transfer @relation(fields: [transferId], references: [id], onDelete: Cascade)
  product  Product  @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@unique([transferId, productId])
  @@map("transfer_items")
  @@index([productId])
}

// ==========================================
// AUDIT LOG (aktivitas user)
// ==========================================

model AuditLog {
  id        String   @id @default(cuid())
  action    String   @db.VarChar(40) // CREATE/UPDATE/DELETE/LOGIN/LOGOUT/POST_TRANSFER/...
  entity    String   @db.VarChar(60) // product/category/warehouse/transfer/role/user/...
  entityId  String?  @db.VarChar(80)
  oldData   Json?
  newData   Json?
  ipAddress String?  @db.VarChar(100)
  userAgent String?  @db.VarChar(500)
  createdAt DateTime @default(now())

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Restrict)

  @@index([entity, entityId])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}
